@page
@model Foromanager.Pages.Foros.DetailsModel
@using Microsoft.AspNetCore.Identity
@using Foromanager.Pages.Foros
@using Foromanager.Models
@using Microsoft.EntityFrameworkCore
@inject UserManager<Usuario> UserManager
@inject ApplicationDbContext DbContext


@{
    ViewData["Title"] = "Detalles";
    int Likes=0;
    int DisLikes=0;
}
<head>
    <link rel="stylesheet" href="~/css/Foros/Details.css" />
</head>


<div>
    <br />
    <h2 class="TituloForo">@Html.DisplayFor(model => model.Foro.Nombre)</h2>
    <hr color="white"/>
    @*<dl class="row">
            <dt class="col-sm-2">
                @Html.DisplayNameFor(model => model.Foro.Descripcion)
            </dt>
            <dd class="col-sm-10">
                @Html.DisplayFor(model => model.Foro.Descripcion)
            </dd>
            <dt class="col-sm-2">
                @Html.DisplayNameFor(model => model.Foro.Categorias)
            </dt>
            <dd class="col-sm-10">
                @Html.DisplayFor(model => model.Foro.Categorias)
            </dd>
            <dt class="col-sm-2">
                @Html.DisplayNameFor(model => model.Foro.Fecha)
            </dt>
            <dd class="col-sm-10">
                @Html.DisplayFor(model => model.Foro.Fecha)
            </dd>
        </dl>*@
 <br />
 @foreach (var item in Model.Foro.Publicaciones)
  {
     var imagenes = await DbContext.Imagenes.Where(i => i.PublicacionId == item.PublicacionId).ToListAsync();

     <br />
     <div class="DivNombreUsuario"> 
         <h3 class="NombreUsuario">@Html.DisplayFor(modelItem => item.Usuario):</h3>
     </div>         
     <div class="DivPublicaciones">
         <p class="TituloPublicacion">@Html.DisplayFor(modelItem => item.Titulo)</p>
         <p class="ComentarioPublicacion">@Html.DisplayFor(modelItem => item.Descripcion)</p>
         <div class="DivImagen"><image class="ImagenPublicacion" src="data:image;base64,@Convert.ToBase64String(imagenes[0].Imagen)"></image></div>
         @if (item.Usuario == @User.Identity.Name)
         {
             <br />
             <p class="BotonesPublicaciones">
                    <a class="BorrarPublicacion" asp-page="../Publicaciones/Delete" asp-route-id="@item.PublicacionId">Borrar</a>
                    <a class="EditarPublicacion" asp-page="../Publicaciones/Edit" asp-route-id="@item.PublicacionId">Editar</a>
             </p>
         }
     </div>
  }

 <br />
 <hr color="white" />
    <form enctype="multipart/form-data" class="col-sm-10 row-sm-10 FormCreacion" method="post">
        
        <dv class="CrearTitulo">
            <input asp-for="Publicacion.Titulo" class="form-control Titulo-input" type="text" placeholder="Titulo"></input>
            <span asp-validation-for="Publicacion.Titulo" class="text-danger Titulo-span"></span>
        </dv>

        <div class="CrearComentario">
            <textarea asp-for="Publicacion.Descripcion" rows="5" cols="40" class="Comentario-textarea" placeholder="Comentario"></textarea>
            <span asp-validation-for="Publicacion.Descripcion" class="text-danger Comentario-span"></span>
        </div>

        <div class="CrearImagen"><input asp-for="ImgCarga" type="file" name="imagen"/></div>

        <br />
        <div class="form-group">
            <button type="submit" class="btn BotonPublicar" asp-for="@Acciones.postear">Publicar</button>
        </div>
    </form>
</div>

@if (Model.Foro.Status != ForumStatus.Approved)
{
    @if ((await AuthorizationService.AuthorizeAsync(User, Model.Foro, ForumOperations.Approve)).Succeeded)
    {
        <form style="display:inline;" method="post">
            <input type="hidden" name="id" value="@Model.Foro.ForoId" />
            <input type="hidden" name="status" value="@ForumStatus.Approved" />
            <button asp-for="@Acciones.aprobar" type="submit" class="btn btn-xs btn-success">Aprobar</button>
        </form>
    }
}

@if (Model.Foro.Status != ForumStatus.Rejected)
{
    @if ((await AuthorizationService.AuthorizeAsync(User, Model.Foro, ForumOperations.Reject)).Succeeded)
    {
        <form style="display:inline;" method="post">
            <input type="hidden" name="id" value="@Model.Foro.ForoId" />
            <input  type="hidden" name="status" value="@ForumStatus.Rejected" />
            <button asp-for="@Acciones.descartar" type="submit" class="btn btn-xs btn-danger">Rechazar</button>
        </form>
    }
}

<footer class="DivBotonesExtras">
    @if ((await AuthorizationService.AuthorizeAsync(User, Model.Foro,ForumOperations.Update)).Succeeded)
    {
        <a asp-page="./Edit" asp-route-id="@Model.Foro.ForoId" class="BotonesExtras">Editar</a>
    }
    <a asp-page="./Index" class="BotonesExtras">Volver a la Lista</a>
    <a asp-page="../Index" class="BotonesExtras">Volver a Inicio</a>
</footer>
